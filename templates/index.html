<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slide Harmony | PowerPoint Converter</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #ffd194;
      --primary-hover: #E8B98D;
      --background: linear-gradient(135deg, #F6F4F0 0%, #ffd194 100%);
      --surface: rgba(255, 255, 255, 0.97);
      --text-primary: #4A4036;
      --text-secondary: #8C7B6D;
      --border-color: #FFE4C4;
      --shadow: 0 8px 24px rgba(255, 209, 148, 0.12);
      --shadow-hover: 0 12px 32px rgba(255, 209, 148, 0.2);
      --accent-1: #FFF9F2;
      --accent-2: #FFE4C4;
      --gradient-1: linear-gradient(135deg, #ffd194 0%, #F6E6D8 100%);
      --gradient-2: linear-gradient(135deg, #F6E6D8 0%, #E8B98D 100%);
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body { 
      height: 100%;
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
    }

    body { 
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
      background: var(--background);
    }

    .container {
      background-color: var(--surface);
      padding: 3rem;
      border-radius: 2rem;
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 209, 148, 0.2);
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: var(--gradient-1);
      opacity: 0.9;
    }

    .logo-section {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .logo-placeholder {
      width: 48px;
      height: 48px;
      background: var(--gradient-2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-size: 1.5rem;
      font-weight: 500;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .logo-placeholder:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .title-section {
      display: flex;
      flex-direction: column;
    }

    h2 {
      color: var(--text-primary);
      font-size: 2.2rem;
      font-weight: 500;
      letter-spacing: -0.025em;
      margin: 0;
      line-height: 1.2;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 400;
      margin-top: 0.5rem;
    }

    form {
      display: contents;
    }

    .form-left, .form-right {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 400;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    input[type="file"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      background-color: var(--accent-1);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    input[type="file"] {
      padding: 0.5rem;
      background-color: var(--accent-1);
      border: 1px dashed var(--accent-2);
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 209, 148, 0.15);
    }

    .note {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 22px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--accent-2);
      transition: .3s;
      border-radius: 22px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background: var(--gradient-1);
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .toggle-label {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    button {
      grid-column: 1 / -1;
      width: 100%;
      padding: 1rem;
      background: var(--gradient-1);
      color: var(--text-primary);
      border: none;
      border-radius: 0.75rem;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    button:hover {
      background: var(--gradient-2);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .progress-container {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .progress-popup {
      display: none;
      background: var(--gradient-2);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 209, 148, 0.2);
    }

    .stop-button {
      display: none;
      background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.2);
    }

    .stop-button:hover {
      background: linear-gradient(135deg, #ff4757 0%, #ff3b47 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 71, 87, 0.3);
    }

    .stop-button:active {
      transform: translateY(0);
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 1.5rem;
        width: 95%;
      }

      body {
        padding: 1rem;
      }

      h2 {
        font-size: 1.5rem;
      }

      .form-left, .form-right {
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-section">
      <div class="logo-placeholder">SH</div>
      <div class="title-section">
        <h2>Slide Harmony</h2>
        <div class="subtitle">Seamless PowerPoint Translation & Formatting</div>
      </div>
    </div>
    <form id="convertForm" method="POST" enctype="multipart/form-data">
      <div class="form-left">
        <div class="input-group">
          <label for="file">Select PowerPoint (.pptx)</label>
          <input type="file" id="file" name="file" accept=".pptx" required>
        </div>
        <div class="input-group">
          <label for="outputName">Output File Name</label>
          <input type="text" id="outputName" name="outputName" placeholder="converted_version" required>
        </div>
      </div>
      <div class="form-right">
        <div class="input-group">
          <label for="slideNumbers">Slide Numbers to Modify</label>
          <input type="text" id="slideNumbers" name="slideNumbers" placeholder="e.g. 2,4,6">
      <div class="note">Leave blank to modify all slides</div>
        </div>
        <div class="input-group">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="translationToggle" name="translationToggle" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label">Enable Translation</span>
          </div>
          <label for="conversionDirection">Conversion Direction</label>
          <select id="conversionDirection" name="conversionDirection" required>
        <option value="en_to_ar">English to Arabic</option>
        <option value="ar_to_en">Arabic to English</option>
      </select>
        </div>
      </div>
      <button type="submit">Convert & Download</button>
    </form>
  </div>

  <div class="progress-container">
    <div class="progress-popup" id="progressBox">Format Conversion: 0%</div>
    <div class="progress-popup" id="translationProgressBox">Translation: 0%</div>
    <button class="stop-button" id="stopButton">Stop Process</button>
  </div>

  <script>
    let conversionPercent = 0;
    let translationPercent = 0;
    let conversionInterval = null;
    let translationInterval = null;
    let abortController = null;

    function updateProgress(message, percentage, type) {
      if (type === 'conversion') {
      const box = document.getElementById('progressBox');
        box.innerText = `${message} ${Math.round(percentage)}%`;
        console.log(`[Progress] Conversion: ${message} ${Math.round(percentage)}%`);
      } else if (type === 'translation') {
        const box = document.getElementById('translationProgressBox');
        box.innerText = `${message} ${Math.round(percentage)}%`;
        console.log(`[Progress] Translation: ${message} ${Math.round(percentage)}%`);
      }
    }

    function showError(message) {
      const conversionBox = document.getElementById('progressBox');
      const translationBox = document.getElementById('translationProgressBox');
      const stopButton = document.getElementById('stopButton');
      conversionBox.innerText = `Error: ${message}`;
      translationBox.innerText = `Error: ${message}`;
      stopButton.style.display = 'none';
      console.error(`[Error] ${message}`);
      clearInterval(conversionInterval);
      clearInterval(translationInterval);
      setTimeout(() => {
        conversionBox.style.display = 'none';
        translationBox.style.display = 'none';
      }, 5000);
    }

    function startProgressIndicators(enableTranslation) {
      console.log('[System] Starting progress indicators, translation enabled:', enableTranslation);
      // Show conversion progress box and stop button
      document.getElementById('progressBox').style.display = 'block';
      document.getElementById('stopButton').style.display = 'block';
      if (enableTranslation) {
        document.getElementById('translationProgressBox').style.display = 'block';
        document.getElementById('translationProgressBox').innerText = 'Translation: Waiting for conversion to complete...';
      }

      // Reset progress
      conversionPercent = 0;
      translationPercent = 0;
      updateProgress('Starting format conversion...', 0, 'conversion');

      // Start conversion progress
      conversionInterval = setInterval(() => {
        if (conversionPercent < 95) {
          conversionPercent += 1;
          updateProgress('Format conversion in progress...', conversionPercent, 'conversion');
        }
      }, 100);
    }

    function startTranslationProgress() {
      console.log('[System] Starting translation progress');
      clearInterval(conversionInterval);
      updateProgress('Format conversion complete!', 100, 'conversion');
      
      // Start translation progress
      translationInterval = setInterval(() => {
        if (translationPercent < 95) {
          translationPercent += 1;
          updateProgress('Translation in progress...', translationPercent, 'translation');
        }
      }, 100);
    }

    function stopProcess() {
      console.log('[System] Stopping process...');
      if (abortController) {
        abortController.abort();
      }
      clearInterval(conversionInterval);
      clearInterval(translationInterval);
      
      // Hide progress boxes and stop button
      document.getElementById('progressBox').style.display = 'none';
      document.getElementById('translationProgressBox').style.display = 'none';
      document.getElementById('stopButton').style.display = 'none';
      
      // Enable form elements
      document.getElementById('convertForm').querySelectorAll('input, select, button').forEach(element => {
        element.disabled = false;
      });
    }

    document.getElementById('stopButton').addEventListener('click', stopProcess);

    document.getElementById('convertForm').addEventListener('submit', async function(e) {
      e.preventDefault(); // Prevent default form submission
      
      try {
        // Disable form elements during conversion
        this.querySelectorAll('input, select, button').forEach(element => {
          element.disabled = true;
        });

        // Create new AbortController for this request
        abortController = new AbortController();
        
        await startLoading();
      } catch (error) {
        console.error('[Error]', error);
        showError(error.message);
      }
    });

    // Add Google Translate API script
    function loadGoogleTranslate() {
        const script = document.createElement('script');
        script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(script);
    }

    // Initialize Google Translate
    function googleTranslateElementInit() {
        new google.translate.TranslateElement({
            pageLanguage: 'en',
            includedLanguages: 'en,ar',
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE
        }, 'google_translate_element');
    }

    // Function to translate text using Google Translate
    async function translateText(text, sourceLang, targetLang) {
        try {
            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
            const data = await response.json();
            return data[0][0][0];
        } catch (error) {
            console.error('[Translation Error]', error);
            return text; // Return original text if translation fails
        }
    }

    async function startLoading() {
      const fileInput = document.getElementById('file');
      const outputName = document.getElementById('outputName').value;
      const conversionDirection = document.getElementById('conversionDirection').value;
      const slideNumbers = document.getElementById('slideNumbers').value;
      const enableTranslation = document.getElementById('translationToggle').checked;

      if (!fileInput.files.length) {
        showError('Please select a file');
        return;
      }

      if (!outputName) {
        showError('Please enter an output name');
        return;
      }

      const file = fileInput.files[0];
      const chunkSize = 1024 * 1024; // 1MB chunks
      const totalChunks = Math.ceil(file.size / chunkSize);
      let uploadedChunks = 0;

      console.log('[System] Starting conversion with:', {
        fileName: file.name,
        fileSize: file.size,
        totalChunks,
        outputName,
        conversionDirection,
        slideNumbers,
        enableTranslation
      });

      // Start progress indicators
      startProgressIndicators(enableTranslation);

      try {
        // Upload file in chunks
        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
          const start = chunkIndex * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append('file', chunk);
          formData.append('chunk', chunkIndex);
          formData.append('total', totalChunks);
          formData.append('filename', file.name);

          const response = await fetch('/upload-chunk', {
            method: 'POST',
            body: formData,
            signal: abortController.signal
          });

          if (!response.ok) {
            throw new Error(`Failed to upload chunk ${chunkIndex + 1}/${totalChunks}`);
          }

          uploadedChunks++;
          const uploadProgress = (uploadedChunks / totalChunks) * 100;
          updateProgress(`Uploading file: ${Math.round(uploadProgress)}%`, uploadProgress, 'conversion');
        }

        // Start conversion process
        console.log('[System] File upload complete, starting conversion...');
        const formData = new FormData();
        formData.append('outputName', outputName);
        formData.append('conversionDirection', conversionDirection);
        formData.append('slideNumbers', slideNumbers);
        formData.append('translationToggle', enableTranslation);

        const response = await fetch('/convert', {
          method: 'POST',
          body: formData,
          signal: abortController.signal
        });

        console.log('[System] Received response:', response.status);
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const data = await response.json();
        console.log('[System] Processing response data:', data);
        
        if (data.error) {
          throw new Error(data.error);
        }

        if (data.status === 'aborted') {
          console.log('[System] Process was aborted');
          return;
        }

        // Start translation progress if enabled
        if (enableTranslation) {
          startTranslationProgress();
        }
        
        if (!data.download_url) {
          throw new Error('No download URL received from server');
        }

        console.log('[System] Download URL received:', data.download_url);
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = data.download_url;
        link.download = outputName + '.pptx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('[System] Download triggered');

      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('[System] Request was aborted');
          showError('Process was stopped by user');
        } else {
          console.error('[Error] Conversion failed:', error);
          showError(error.message || 'Conversion failed. Please try again.');
        }
        throw error;
      } finally {
        console.log('[System] Cleaning up...');
        stopLoading();
      }
    }

    function stopLoading() {
      console.log('[System] Stopping progress indicators');
      clearInterval(conversionInterval);
      clearInterval(translationInterval);
      
      // Hide progress boxes and stop button
      document.getElementById('progressBox').style.display = 'none';
      document.getElementById('translationProgressBox').style.display = 'none';
      document.getElementById('stopButton').style.display = 'none';
      
      // Enable form elements
      document.getElementById('convertForm').querySelectorAll('input, select, button').forEach(element => {
        element.disabled = false;
      });
    }
  </script>
</body>
</html>
